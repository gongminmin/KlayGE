SET(PY_VERSION_MAJOR 3)
SET(PY_VERSION_MINOR 7)
SET(PY_VERSION_PATCH 2)
SET(PY_VERSION "${PY_VERSION_MAJOR}.${PY_VERSION_MINOR}.${PY_VERSION_PATCH}")

SET(PYTHON_PROJECT_DIR "${EXTERNAL_PROJECT_DIR}/Python")
SET(PYTHON_OUTPUT_DIR "${EXTERNAL_PROJECT_DIR}/lib/Python/${KLAYGE_PLATFORM_NAME}")

UpdateExternalLib("Python" "https://github.com/gongminmin/cpython.git" "1e77e85097cfc6ff5ac52aeb5f8afc63b384a599" "FixForKlayGE" "v${PY_VERSION}")
UpdateExternalLib("python-cmake-buildsystem" "https://github.com/gongminmin/python-cmake-buildsystem.git" "f6810df467b99a769696003097081462d4fb6ecd" "FixForKlayGE" "master")

SET(SRC_DIR ${PYTHON_PROJECT_DIR})

FOREACH(flag_var
		CMAKE_C_FLAGS CMAKE_CXX_FLAGS)
	IF(KLAYGE_COMPILER_MSVC)
		SET(${flag_var} "${${flag_var}} /wd4273 /wd4013 /wd4133 /wd4703")
	ENDIF()
ENDFOREACH()
IF(KLAYGE_COMPILER_MSVC)
	IF(MSVC_VERSION GREATER 1800)
		ADD_DEFINITIONS(-D_CRT_NON_CONFORMING_WCSTOK)
	ENDIF()
	string(REPLACE "/WX" "/WX:NO" CMAKE_STATIC_LINKER_FLAGS ${CMAKE_STATIC_LINKER_FLAGS})
ENDIF()

IF(ANDROID OR IOS)
	SET(UNIX OFF)
	SET(LINUX OFF)
ENDIF()

SET(PYTHON_VERSION ${PY_VERSION} CACHE STRING "" FORCE)

set(BUILD_PYTHON_EXECUTABLE OFF CACHE BOOL "" FORCE)
set(BUILD_PYTHON_DEVELOPMENT OFF CACHE BOOL "" FORCE)
set(BUILD_FREEZE_IMPORTLIB OFF CACHE BOOL "" FORCE)
set(BUILD_PGEN OFF CACHE BOOL "" FORCE)

set(CMAKE_CONFIGURATION_TYPES "Debug;Release;RelWithDebInfo;MinSizeRel" CACHE STRING "" FORCE)

set(DOWNLOAD_SOURCES OFF CACHE BOOL "" FORCE)
set(BUILD_LIBPYTHON_SHARED OFF CACHE BOOL "" FORCE)

set(BUILD_EXTENSIONS_AS_BUILTIN ON CACHE BOOL "" FORCE)
set(BUILD_WININST OFF CACHE BOOL "" FORCE)
set(ENABLE_AUDIOOP OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_CN OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_HK OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_ISO2022 OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_JP OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_KR OFF CACHE BOOL "" FORCE)
set(ENABLE_CODECS_TW OFF CACHE BOOL "" FORCE)
set(ENABLE_CTYPES OFF CACHE BOOL "" FORCE)
set(ENABLE_CTYPES_TEST OFF CACHE BOOL "" FORCE)
set(ENABLE_DECIMAL OFF CACHE BOOL "" FORCE)
set(ENABLE_ELEMENTTREE OFF CACHE BOOL "" FORCE)
set(ENABLE_IPV6 OFF CACHE BOOL "" FORCE)
set(ENABLE_LOCALE OFF CACHE BOOL "" FORCE)
set(ENABLE_MMAP OFF CACHE BOOL "" FORCE)
set(ENABLE_MSI OFF CACHE BOOL "" FORCE)
set(ENABLE_MSVCRT OFF CACHE BOOL "" FORCE)
set(ENABLE_MULTIBYTECODEC OFF CACHE BOOL "" FORCE)
set(ENABLE_MULTIPROCESSING OFF CACHE BOOL "" FORCE)
set(ENABLE_OSSAUDIODEV OFF CACHE BOOL "" FORCE)
set(ENABLE_OVERLAPPED OFF CACHE BOOL "" FORCE)
set(ENABLE_PICKLE OFF CACHE BOOL "" FORCE)
set(ENABLE_PYEXPAT OFF CACHE BOOL "" FORCE)
set(ENABLE_SCPROXY OFF CACHE BOOL "" FORCE)
set(ENABLE_SELECT OFF CACHE BOOL "" FORCE)
set(ENABLE_SOCKET OFF CACHE BOOL "" FORCE)
set(ENABLE_SQLITE3 OFF CACHE BOOL "" FORCE)
set(ENABLE_SUBPROCESS OFF CACHE BOOL "" FORCE)
set(ENABLE_TESTCAPI OFF CACHE BOOL "" FORCE)
set(ENABLE_WINAPI OFF CACHE BOOL "" FORCE)
if(KLAYGE_PLATFORM_WINDOWS)
	set(ENABLE_WINREG ON CACHE BOOL "" FORCE)
endif()
set(INSTALL_DEVELOPMENT OFF CACHE BOOL "" FORCE)
set(INSTALL_MANUAL OFF CACHE BOOL "" FORCE)
set(INSTALL_TEST OFF CACHE BOOL "" FORCE)
set(INSTALL_WINDOWS_TRADITIONAL OFF CACHE BOOL "" FORCE)
set(PYTHON_APPLY_PATCHES OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_BZip2 OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_Curses OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_EXPAT OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_DB OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_GDBM OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_OpenSSL OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_READLINE OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_TCL OFF CACHE BOOL "" FORCE)
set(USE_SYSTEM_ZLIB OFF CACHE BOOL "" FORCE)
set(WITH_COMPUTED_GOTOS OFF CACHE BOOL "" FORCE)
set(WITH_DOC_STRINGS OFF CACHE BOOL "" FORCE)
set(WITH_TSC OFF CACHE BOOL "" FORCE)
set(USE_BUILTIN_ZLIB OFF CACHE BOOL "" FORCE)

IF(KLAYGE_PLATFORM_WINDOWS_STORE)
	ADD_DEFINITIONS(-D_WIN32_WINNT=0x0A00)
	ADD_DEFINITIONS(-DWINVER=0x0A00)
	ADD_DEFINITIONS(-DNTDDI_VERSION=0x0A000000)
ENDIF()

IF(CMAKE_CROSSCOMPILING)
	STRING(TOLOWER ${CMAKE_SYSTEM_NAME} lc_system_name)
	IF(APPLE)
		SET(PLATFORM_RUN__TRYRUN_OUTPUT "${lc_system_name}")
	ELSE()
		SET(PLATFORM_RUN__TRYRUN_OUTPUT "${CMAKE_SYSTEM_PROCESSOR}-${lc_system_name}")
	ENDIF()
	SET(PLATFORM_RUN "0")

	SET(HAVE_MMAP_DEV_ZERO_EXITCODE 1)
	SET(HAVE_BROKEN_NICE_EXITCODE 1)
	SET(HAVE_BROKEN_POLL_EXITCODE 1)

	SET(DOUBLE_IS_LITTLE_ENDIAN_IEEE754 1)
	SET(DOUBLE_IS_BIG_ENDIAN_IEEE754 0)
	SET(DOUBLE_IS_ARM_MIXED_ENDIAN_IEEE754 0)
	SET(X87_DOUBLE_ROUNDING 0)
	SET(POSIX_SEMAPHORES_NOT_ENABLED 0)
	SET(HAVE_BROKEN_SEM_GETVALUE 0)
	SET(HAVE_WORKING_TZSET 0)
	SET(HAVE_ALIGNED_REQUIRED 0)
	SET(HAVE_BROKEN_MBSTOWCS 0)
	SET(HAVE_COMPUTED_GOTOS 0)
	SET(HAVE_GLIBC_MEMMOVE_BUG 0)
	SET(HAVE_LONG_LONG_FORMAT 0)
	SET(HAVE_SIZE_T_FORMAT 0)
ENDIF()

IF(ANDROID OR IOS)
	set(WITH_STATIC_DEPENDENCIES ON)
ENDIF()

ADD_DEFINITIONS(-DPy_BUILD_CORE)

ADD_SUBDIRECTORY("${EXTERNAL_PROJECT_DIR}/python-cmake-buildsystem" "${CMAKE_CURRENT_BINARY_DIR}/python")

SET_TARGET_PROPERTIES(libpython-static PROPERTIES
	ARCHIVE_OUTPUT_DIRECTORY ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_DEBUG ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELEASE ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELWITHDEBINFO ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_MINSIZEREL ${PYTHON_OUTPUT_DIR}
	PROJECT_LABEL libpython-static
	DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX}
	OUTPUT_NAME python${KLAYGE_OUTPUT_SUFFIX}
	FOLDER "${EXTERNAL_VS_FOLDER_PREFIX}/Python"
)

add_dependencies(libpython-static ${KLAYGE_ZLIB_NAME})

PROJECT(FreeImage)

CMAKE_MINIMUM_REQUIRED(VERSION 3.4)

SET(FREEIMAGE_VERSION_MAJOR 3)
SET(FREEIMAGE_VERSION_MINOR 17)
SET(FREEIMAGE_VERSION_PATCH 0)
SET(FREEIMAGE_VERSION ${FREEIMAGE_VERSION_MAJOR}${FREEIMAGE_VERSION_MINOR}${FREEIMAGE_VERSION_PATCH})

SET(FREEIMAGE_PROJECT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../..")
SET(KLAYGE_ROOT_DIR "${FREEIMAGE_PROJECT_DIR}/../..")

INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Common.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Platform.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Compiler.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/External/Build/CMake/ExternalCommon.cmake)

SET_PROPERTY(GLOBAL PROPERTY USE_FOLDERS ON)

SET(FREEIMAGE_OUTPUT_DIR "${FREEIMAGE_PROJECT_DIR}/lib/${KLAYGE_PLATFORM_NAME}")
SET(KLAYGE_BIN_DIR "${KLAYGE_ROOT_DIR}/KlayGE/bin/${KLAYGE_PLATFORM_NAME}")
SET(REL_PATH "External/Downloads/FreeImage${FREEIMAGE_VERSION}.patched.7z")
SET(SEVENZIP_PATH "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z")
SET(PACKAGE_COMMIT_ID "6faaf1908109e9c021f9fc8f3b1a88a59146feba")
SET(PACKAGE_FILE_ID "4fcdad5a7550a02b5cc84d9696ff9123a110161b")

DOWNLOAD_PACKAGE("FreeImage" ${REL_PATH} ${PACKAGE_COMMIT_ID} ${PACKAGE_FILE_ID} "Whatsnew.txt")

FOREACH(flag_var
		CMAKE_C_FLAGS CMAKE_CXX_FLAGS)
	IF(KLAYGE_COMPILER_MSVC)
		STRING(REPLACE "/W4" "/W3" ${flag_var} "${${flag_var}}")
		STRING(REPLACE "/WX" "/WX-" ${flag_var} "${${flag_var}}")
	ELSE()
		STRING(REPLACE "-Werror" "-Wno-error" ${flag_var} "${${flag_var}}")
	ENDIF()
ENDFOREACH()
IF(KLAYGE_COMPILER_MSVC)
	STRING(REPLACE "/WX" "/WX:NO" CMAKE_STATIC_LINKER_FLAGS ${CMAKE_STATIC_LINKER_FLAGS})
ELSEIF((KLAYGE_PLATFORM_DARWIN OR KLAYGE_PLATFORM_IOS) AND KLAYGE_COMPILER_CLANG AND (KLAYGE_COMPILER_VERSION STRGREATER "89"))
	SET(CMAKE_CXX_FLAGS "${CMAAKE_CXX_FLAGS} -Wno-register -Wno-c++11-narrowing")
ENDIF()
FOREACH(flag_var
		CMAKE_CXX_FLAGS_RELEASE CMAKE_CXX_FLAGS_RELWITHDEBINFO CMAKE_CXX_FLAGS_MINSIZEREL)
	STRING(REPLACE "${NO_RTTI_FLAG}" "${RTTI_FLAG}" ${flag_var} "${${flag_var}}")
ENDFOREACH()

IF(KLAYGE_PLATFORM_WINDOWS)
	ADD_DEFINITIONS(-DWIN32)
ELSE()
	ADD_DEFINITIONS(-D__ANSI__)
ENDIF()

ADD_SUBDIRECTORY(FreeImage)
ADD_SUBDIRECTORY(LibJPEG)
ADD_SUBDIRECTORY(LibJXR)
ADD_SUBDIRECTORY(LibOpenJPEG)
ADD_SUBDIRECTORY(LibPNG)
ADD_SUBDIRECTORY(LibRaw)
ADD_SUBDIRECTORY(LibTIFF4)
ADD_SUBDIRECTORY(LibWebP)
ADD_SUBDIRECTORY(OpenEXR)
ADD_SUBDIRECTORY(ZLib)

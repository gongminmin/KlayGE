CMAKE_MINIMUM_REQUIRED(VERSION 2.8.6)

PROJECT(Python C)

SET(PY_VERSION_MAJOR 3)
SET(PY_VERSION_MINOR 5)
SET(PY_VERSION_PATCH 1)
SET(PY_VERSION "${PY_VERSION_MAJOR}.${PY_VERSION_MINOR}.${PY_VERSION_PATCH}")

SET(PYTHON_PROJECT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../..")
SET(KLAYGE_ROOT_DIR "${PYTHON_PROJECT_DIR}/../..")

INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Common.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Platform.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Compiler.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/External/Build/CMake/ExternalCommon.cmake)

SET_PROPERTY(GLOBAL PROPERTY USE_FOLDERS ON)

SET(PYTHON_OUTPUT_DIR "${PYTHON_PROJECT_DIR}/libs/${KLAYGE_PLATFORM_NAME}")
SET(REL_PATH "External/Downloads/Python-${PY_VERSION}.patched.7z")
SET(SEVENZIP_PATH "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z")
SET(PACKAGE_COMMIT_ID "9e7ea8dadd7fd80385b3d89fc1cbb05c256c9d47")
SET(PACKAGE_FILE_ID "5d373d1c79ecf129eb0e5d332e865a337f227adc")

DOWNLOAD_PACKAGE("Python" ${REL_PATH} ${PACKAGE_COMMIT_ID} ${PACKAGE_FILE_ID} "README")

SET(PACKAGE_COMMIT_ID "f7311aa3e0d710a0c6fee5cc22499b92b1c0b343")
SET(PACKAGE_FILE_ID "bf083f45d8723febb6ae3dc004f30db107eb33f7")

DOWNLOAD_PACKAGE("Python/Build/cmake/python-cmake-buildsystem" "External/Downloads/python-cmake-buildsystem.patched.7z" ${PACKAGE_COMMIT_ID} ${PACKAGE_FILE_ID} "README.rst")

SET(SRC_DIR ${PYTHON_PROJECT_DIR})

FOREACH(flag_var
		CMAKE_C_FLAGS CMAKE_CXX_FLAGS)
	IF(KLAYGE_COMPILER_MSVC)
		STRING(REPLACE "/W4" "/W3" ${flag_var} "${${flag_var}}")
		STRING(REPLACE "/WX" "/WX-" ${flag_var} "${${flag_var}}")
		SET(${flag_var} "${${flag_var}} /wd4273 /we4013 /we4133")
	ELSE()
		STRING(REPLACE "-Werror" "-Wno-error" ${flag_var} "${${flag_var}}")
	ENDIF()
ENDFOREACH()
IF(KLAYGE_COMPILER_MSVC)
	IF(MSVC_VERSION GREATER 1800)
		ADD_DEFINITIONS(-D_CRT_NON_CONFORMING_WCSTOK)
	ENDIF()
ENDIF()

IF(ANDROID OR IOS)
	SET(UNIX OFF)
	SET(LINUX OFF)
ENDIF()

SET(PYTHON_VERSION ${PY_VERSION} CACHE STRING "")

OPTION(BUILD_PYTHON_EXECUTABLE "" OFF)
OPTION(BUILD_PYTHON_DEVELOPMENT "" OFF)
OPTION(BUILD_FREEZE_IMPORTLIB "" OFF)
OPTION(BUILD_PGEN "" OFF)

SET(CMAKE_CONFIGURATION_TYPES "Debug;Release;RelWithDebInfo;MinSizeRel" CACHE STRING "")

OPTION(DOWNLOAD_SOURCES "" OFF)
OPTION(BUILD_LIBPYTHON_SHARED "" OFF)

OPTION(BUILD_EXTENSIONS_AS_BUILTIN "" ON)
OPTION(BUILD_WININST "" OFF)
OPTION(ENABLE_AUDIOOP "" OFF)
OPTION(ENABLE_CODECS_CN "" OFF)
OPTION(ENABLE_CODECS_HK "" OFF)
OPTION(ENABLE_CODECS_ISO2022 "" OFF)
OPTION(ENABLE_CODECS_JP "" OFF)
OPTION(ENABLE_CODECS_KR "" OFF)
OPTION(ENABLE_CODECS_TW "" OFF)
OPTION(ENABLE_CTYPES "" OFF)
OPTION(ENABLE_CTYPES_TEST "" OFF)
OPTION(ENABLE_DECIMAL "" OFF)
OPTION(ENABLE_IPV6 "" OFF)
OPTION(ENABLE_LOCALE "" OFF)
OPTION(ENABLE_MMAP "" OFF)
OPTION(ENABLE_MSI "" OFF)
OPTION(ENABLE_MSVCRT "" OFF)
OPTION(ENABLE_MULTIBYTECODEC "" OFF)
OPTION(ENABLE_MULTIPROCESSING "" OFF)
OPTION(ENABLE_OSSAUDIODEV "" OFF)
OPTION(ENABLE_OVERLAPPED "" OFF)
OPTION(ENABLE_PICKLE "" OFF)
OPTION(ENABLE_PYEXPAT "" OFF)
OPTION(ENABLE_SCPROXY "" OFF)
OPTION(ENABLE_SELECT "" OFF)
OPTION(ENABLE_SOCKET "" OFF)
OPTION(ENABLE_SQLITE3 "" OFF)
OPTION(ENABLE_SUBPROCESS "" OFF)
OPTION(ENABLE_TESTCAPI "" OFF)
OPTION(ENABLE_WINAPI "" OFF)
OPTION(INSTALL_DEVELOPMENT "" OFF)
OPTION(INSTALL_MANUAL "" OFF)
OPTION(INSTALL_TEST "" OFF)
OPTION(INSTALL_WINDOWS_TRADITIONAL "" OFF)
OPTION(PYTHON_APPLY_PATCHES "" OFF)
OPTION(USE_SYSTEM_BZip2 "" OFF)
OPTION(USE_SYSTEM_Curses "" OFF)
OPTION(USE_SYSTEM_EXPAT "" OFF)
OPTION(USE_SYSTEM_DB "" OFF)
OPTION(USE_SYSTEM_GDBM "" OFF)
OPTION(USE_SYSTEM_OpenSSL "" OFF)
OPTION(USE_SYSTEM_READLINE "" OFF)
OPTION(USE_SYSTEM_TCL "" OFF)
OPTION(USE_SYSTEM_ZLIB "" OFF)
OPTION(WITH_COMPUTED_GOTOS "" OFF)
OPTION(WITH_DOC_STRINGS "" OFF)
OPTION(WITH_TSC "" OFF)

IF(KLAYGE_PLATFORM_WINDOWS_STORE)
	ADD_DEFINITIONS(-D_WIN32_WINNT=0x0602)
	ADD_DEFINITIONS(-DWINVER=0x0602)
	ADD_DEFINITIONS(-DNTDDI_VERSION=0x06020000)
ENDIF()

IF(CMAKE_CROSSCOMPILING)
	STRING(TOLOWER ${CMAKE_SYSTEM_NAME} lc_system_name)
	IF(APPLE)
		SET(PLATFORM_RUN__TRYRUN_OUTPUT "${lc_system_name}")
	ELSE()
		SET(PLATFORM_RUN__TRYRUN_OUTPUT "${CMAKE_SYSTEM_PROCESSOR}-${lc_system_name}")
	ENDIF()
	SET(PLATFORM_RUN "0")

	SET(HAVE_MMAP_DEV_ZERO_EXITCODE 1)
	SET(HAVE_BROKEN_NICE_EXITCODE 1)
	SET(HAVE_BROKEN_POLL_EXITCODE 1)

	SET(DOUBLE_IS_LITTLE_ENDIAN_IEEE754 1)
	SET(DOUBLE_IS_BIG_ENDIAN_IEEE754 0)
	SET(DOUBLE_IS_ARM_MIXED_ENDIAN_IEEE754 0)
	SET(X87_DOUBLE_ROUNDING 0)
	SET(POSIX_SEMAPHORES_NOT_ENABLED 0)
	SET(HAVE_BROKEN_SEM_GETVALUE 0)
	SET(HAVE_WORKING_TZSET 0)
	SET(HAVE_ALIGNED_REQUIRED 0)
	SET(HAVE_BROKEN_MBSTOWCS 0)
	SET(HAVE_COMPUTED_GOTOS 0)
	SET(HAVE_GLIBC_MEMMOVE_BUG 0)
	SET(HAVE_LONG_LONG_FORMAT 0)
	SET(HAVE_SIZE_T_FORMAT 0)
ENDIF()

IF(ANDROID OR IOS)
	OPTION(WITH_STATIC_DEPENDENCIES "" ON)
ENDIF()

ADD_DEFINITIONS(-DPy_BUILD_CORE)

ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/python-cmake-buildsystem" "${CMAKE_CURRENT_BINARY_DIR}/python")

SET_TARGET_PROPERTIES(libpython-static PROPERTIES
	ARCHIVE_OUTPUT_DIRECTORY ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_DEBUG ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELEASE ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELWITHDEBINFO ${PYTHON_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_MINSIZEREL ${PYTHON_OUTPUT_DIR}
	PROJECT_LABEL libpython-static
	DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX}
	OUTPUT_NAME python${KLAYGE_OUTPUT_SUFFIX}
)
